const WOOD_COLORS = {
    "Oak": [234,184,146], "Cherry": [163,75,75], "Fir": [215,197,154], "Birch": [205,205,205], "Walnut": [105,64,40]
};
 
let scene, camera, renderer;
let luaBlocks = [];
 
function closestWood(rgb) {
    let minDist = Infinity;
    let closest = "Oak";
    for (let wood in WOOD_COLORS) {
        let c = WOOD_COLORS[wood];
        let dist = (rgb[0] - c[0]) ** 2 + (rgb[1] - c[1]) ** 2 + (rgb[2] - c[2]) ** 2;
        if (dist < minDist) {
            minDist = dist;
            closest = wood;
        }
    }
    return closest;
}
 
function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight * 0.7);
    document.body.appendChild(renderer.domElement);
    camera.position.z = 80;
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(50, 50, 50);
    scene.add(light);
    animate();
}
 
function animate() {
    requestAnimationFrame(animate);
    scene.rotation.y += 0.005;
    renderer.render(scene, camera);
}
 
function generate() {
    scene.clear();
    luaBlocks = [];
    const file = document.getElementById("imageUpload").files[0];
    if (!file) return alert("Upload image first.");
    const width = parseInt(document.getElementById("width").value);
    const height = parseInt(document.getElementById("height").value);
    const depth = parseInt(document.getElementById("depth").value);
    const img = new Image();
    img.onload = function () {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        for (let z = 0; z < depth; z++) {
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const pixel = ctx.getImageData(x, y, 1, 1).data;
                    const wood = closestWood([pixel[0], pixel[1], pixel[2]]);
                    const color = WOOD_COLORS[wood];
                    const geometry = new THREE.BoxGeometry(1, 1, 1);
                    const material = new THREE.MeshStandardMaterial({ color: `rgb(${color[0]},${color[1]},${color[2]})` });
                    const cube = new THREE.Mesh(geometry, material);
                    cube.position.set(x - width / 2, height - y, z - depth / 2);
                    scene.add(cube);
                    luaBlocks.push(`table.insert(blocks,{Size=Vector3.new(1,1,1),CFrame=CFrame.new(${x},${height-y},${z}),Wood="${wood}"})`);
                }
            }
        }
    };
    img.src = URL.createObjectURL(file);
}
 
function downloadLua() {
    let lua = "local blocks = {}\n\n";
    lua += luaBlocks.join("\n");
    lua += "\n\nreturn blocks";
    const blob = new Blob([lua], { type: "text/plain" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "lt2_build.lua";
    link.click();
}
 
function autoBuild() {
    const walkSpeed = document.getElementById("walkSpeed").value;
    const treeType = document.getElementById("treeType").value;
    const lua = `local walkSpeed = ${walkSpeed}\nlocal treeType = "${treeType}"\n\n`;
    lua += `local blocks = {}\n\n`;
    lua += luaBlocks.join("\n");
    lua += `\n\nreturn {blocks, walkSpeed, treeType}`;
    const blob = new Blob([lua], { type: "text/plain" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "auto_build.lua";
    link.click();
}
 
init3D();
